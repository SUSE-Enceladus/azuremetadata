#!/usr/bin/python3

import argparse
from azuremetadata import azuremetadatautils, azuremetadata


class PreserveArgumentOrder(argparse.Action):
    def __call__(self, parser, namespace, value, option_string=None):
        if 'ordered_args' not in namespace:
            setattr(namespace, 'ordered_args', [])
        namespace.ordered_args.append((self.dest, value))


api_version_parser = argparse.ArgumentParser(add_help=False)
api_version_parser.add_argument('-a', '--api', action="store", help="API version", nargs='?', const=None)
api_args, _ = api_version_parser.parse_known_args()

parser = argparse.ArgumentParser(add_help=False)
parser.add_argument('-h', '--help', action="store_true", help="Display help")
parser.add_argument('-x', '--xml', action="store_true", help="Output as XML")
parser.add_argument('-o', '--output', action="store", help="Output file path")
parser.add_argument('-a', '--api', action="store", help="API version")
parser.add_argument(
    '-t', '--tag', action="store", help="Read VHD disk tag from specified device (default: /dev/sda)",
    nargs='?', const='/dev/sda'
)

metadata = azuremetadata.AzureMetadata(api_args.api)
data = metadata.get_all()

util = azuremetadatautils.AzureMetadataUtils(data)
for key in util.available_params.keys():
    parser.add_argument(f'--{key}', nargs='?', type=int, const=True, action=PreserveArgumentOrder)

args = parser.parse_args()
ordered_args = getattr(args, 'ordered_args', [])

if args.tag:
    data['diskTag'] = metadata.get_disk_tag(args.tag)

try:
    if args.help:
        util.print_help()
        exit()

    print_xml = args.xml

    fh = None
    if args.output:
        fh = open(args.output, 'w')

    try:
        if not len(ordered_args):
            util.print_pretty(print_xml, file=fh)
        else:
            result = util.query(ordered_args)
            for item in result:
                util.print_pretty(print_xml, item, file=fh)
    finally:
        if fh:
            fh.close()

except azuremetadatautils.QueryException as e:
    print(e)
    exit(1)
